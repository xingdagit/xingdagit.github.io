{"tags":[{"name":"JS","permalink":"http://yoursite.com/tags/JS/","url":"\\async\\tags\\JS.json","count":14}],"categories":[],"url":"\\async\\posts\\2017\\06\\04\\JS-文件.json","date":1496562769000,"path":{"year":2017,"month":6,"day":4,"name":"JS-文件"},"title":"JS-文件","permalink":"http://yoursite.com/2017/06/04/JS-文件/","content":"<ul>\n<li><p>在HTML表单中，可以上传文件的唯一控件就是<code>&lt;input type=&quot;file&quot;&gt;</code>。<br>注意：当一个表单包含<code>&lt;input type=&quot;file&quot;&gt;</code>时，表单的<code>enctype</code>必须指定为<code>multipart/form-data</code>，<code>method</code>必须指定为<code>post</code>，浏览器才能正确编码并以<code>multipart/form-data</code>格式发送表单的数据。</p>\n</li>\n<li><p>通常，上传的文件都由后台服务器处理，JavaScript可以在提交表单时对文件扩展名做检查，以便防止用户上传无效格式的文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">var f = document.getElementById(&apos;test-file-upload&apos;);</div><div class=\"line\">var filename = f.value; // &apos;C:\\fakepath\\test.png&apos;</div><div class=\"line\">if (!filename || !(filename.endsWith(&apos;.jpg&apos;) || filename.endsWith(&apos;.png&apos;) || filename.endsWith(&apos;.gif&apos;))) &#123;</div><div class=\"line\">   alert(&apos;Can only upload image file.&apos;);</div><div class=\"line\">   return false;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"File-API\"><a href=\"#File-API\" class=\"headerlink\" title=\"File API\"></a>File API</h3><ul>\n<li>由于JavaScript对用户上传的文件操作非常有限，尤其是无法读取文件内容，使得很多需要操作文件的网页不得不用Flash这样的第三方插件来实现。</li>\n<li>随着HTML5的普及，新增的File API允许JavaScript读取文件内容，获得更多的文件信息。</li>\n<li>HTML5的File API提供了<code>File</code>和<code>FileReader</code>两个主要对象，可以获得文件信息并读取文件。</li>\n<li><p>实例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\">//通过HTML5的File API读取文件内容</div><div class=\"line\">var</div><div class=\"line\">    fileInput = document.getElementById(&apos;test-image-file&apos;),</div><div class=\"line\">    info = document.getElementById(&apos;test-file-info&apos;),</div><div class=\"line\">    preview = document.getElementById(&apos;test-image-preview&apos;);</div><div class=\"line\">// 监听change事件:</div><div class=\"line\">fileInput.addEventListener(&apos;change&apos;, function () </div><div class=\"line\">&#123;</div><div class=\"line\">    preview.style.backgroundImage = &apos;&apos;; // 清除背景图片</div><div class=\"line\">    if (!fileInput.value) // 检查文件是否选择</div><div class=\"line\">    &#123;</div><div class=\"line\">      info.innerHTML = &apos;没有选择文件&apos;;</div><div class=\"line\">      return;</div><div class=\"line\">    &#125;</div><div class=\"line\">    var file = fileInput.files[0]; // 获取File引用</div><div class=\"line\">    // 获取File信息:</div><div class=\"line\">    info.innerHTML = &apos;文件: &apos; + file.name + &apos;&lt;br&gt;&apos; +</div><div class=\"line\">                     &apos;大小: &apos; + file.size + &apos;&lt;br&gt;&apos; +</div><div class=\"line\">                     &apos;修改: &apos; + file.lastModifiedDate;</div><div class=\"line\">    if (file.type !== &apos;image/jpeg&apos; &amp;&amp; file.type !== &apos;image/png&apos; &amp;&amp; file.type !== &apos;image/gif&apos;)</div><div class=\"line\">    &#123;</div><div class=\"line\">      alert(&apos;不是有效的图片文件!&apos;);</div><div class=\"line\">      return;</div><div class=\"line\">    &#125;</div><div class=\"line\">    // 读取文件:</div><div class=\"line\">    var reader = new FileReader();</div><div class=\"line\">    reader.onload = function(e) </div><div class=\"line\">    &#123;</div><div class=\"line\">      var data = e.target.result;  // &apos;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&apos;     </div><div class=\"line\">      preview.style.backgroundImage = &apos;url(&apos; + data + &apos;)&apos;;</div><div class=\"line\">    &#125;;</div><div class=\"line\">    reader.readAsDataURL(file); // 以DataURL的形式读取文件</div><div class=\"line\">    //读取到的文件是一个字符串，类似于上面的base64编码，常用于设置图像</div><div class=\"line\">    //如果需要服务器端处理，把字符串base64,后面的字符发送给服务器并用Base64解码就可以得到原始文件的二进制内容。</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n</li>\n<li><p>上面代码也演示了JavaScript的一个重要的特性就是单线程执行模式。在JavaScript中，浏览器的JavaScript执行引擎在执行JavaScript代码时，总是以单线程模式执行，也就是说，任何时候JavaScript代码都不可能同时有多于1个线程在执行。</p>\n</li>\n<li>单线程模式执行的JavaScript，如何处理多任务？在JavaScript中，执行多任务实际上都是异步调用。</li>\n<li>对于异步操作，我们在JavaScript代码中就不知道什么时候操作结束，因此需先设置一个回调函数，如：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">reader.readAsDataURL(file); //执行多任务(异步调用)</div><div class=\"line\">//设置回调函数:</div><div class=\"line\">reader.onload = function(e) &#123;</div><div class=\"line\">  //当文件读取完成后，JavaScript引擎将自动调用设置的回调函数。</div><div class=\"line\">  //执行回调函数时，文件已经读取完毕，所以我们可在回调函数内部安全地获得文件内容</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></li>\n</ul>\n"}